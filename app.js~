var express = require('express.io');
var app = express().http().io();

var baseurl = "http://localhost:3000"; // default development URL
if (process.env.BASE_URL) {            // if env var is set, use it
  baseurl = process.env.BASE_URL;
}
var url = require('url');
var port = url.parse(baseurl).port;    // parse out the port number
if (process.env.PORT) {
    port = process.env.PORT;
}
console.log("Using baseurl: " + baseurl);
console.log("Port: " + port);

var flash = require('connect-flash');
app.configure(function() {
  app.set('view engine', 'jade');
  app.set('views', __dirname + '/views');
  app.use(express.logger());
  app.use(express.cookieParser('keyboard cat'));
  app.use(express.json());
  app.use(express.urlencoded());
  app.use(express.methodOverride());
  app.use(express.session({cookie: { maxAge: 60000 }, secret: 'secretkeywhichmustnotbenamed'}));
  app.use(flash());
  app.use(app.router);
  app.use(express.static(__dirname + '/public'));
  
});

// set up socket.io routes
var database = require('./database.js');
app.io.route('test_database', database.test_database);
app.io.route('Change User', database.setCurrentUser);


// set up "normal" http routes
var views = require('./views.js');
app.get('/', views.index);
app.get('/#', views.index);
app.get('/test', views.test);
app.get('/home', views.index);
app.get('/wishlist', views.wishlist);
app.get('/gift', views.gift);
app.get('/settings', views.settings);
app.get('/new-user', views.newUser);
app.get('/remove-user', views.removeUser);

app.post('/new-user', views.createNewUser);


app.listen(port);
console.log("App started on port " + port);
